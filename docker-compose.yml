version: "3"
services:
  conflictvisualizer-gui:
    build:
      context: gui
      dockerfile: Dockerfile
      args:
        NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
        NEXTAUTH_URL: ${NEXTAUTH_URL}
        KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
        KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
        KEYCLOAK_REALM: ${KEYCLOAK_REALM}
        MAPBOX_TOKEN: ${MAPBOX_TOKEN}
        GUI_SERVER_URL: ${GUI_SERVER_URL}
        AUTH_SERVER_URL: ${AUTH_SERVER_URL}
        API_SERVER_URL: ${API_SERVER_URL}
        API_WS_URL: ${API_WS_URL}
    restart: always
    ports:
      - "3000:3000"
    image: jpo-conflictvisualizer-gui:latest
    logging:
      options:
        max-size: "10m"
        max-file: "5"

  keycloak:
    build:
      context: keycloak
      dockerfile: Dockerfile
    container_name: jpo-conflictvisualizer-keycloak
    restart: always
    depends_on:
      - postgres
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_CLIENT_API_ID: ${KEYCLOAK_CLIENT_API_ID}
      KEYCLOAK_CLIENT_API_SECRET: ${KEYCLOAK_CLIENT_API_SECRET}
      
      # DB_VENDOR: POSTGRES
      # DB_ADDR: postgres
      # DB_PORT: 5432
      # DB_DATABASE: keycloak
      # DB_USER: keycloak
      # DB_PASSWORD: kc
      
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://${PG_DB_HOST}/postgres?currentSchema=keycloak
      KC_DB_URL_PROVIDER: jdbc:postgresql://${PG_DB_HOST}/postgres
      KC_DB_USERNAME: ${PG_DB_USER}
      KC_DB_PASSWORD: ${PG_DB_PASS}
      KC_HOSTNAME: ${AUTH_SERVER_URL}

      KC_PROXY: edge


      GUI_SERVER_URL: ${GUI_SERVER_URL}
      API_SERVER_URL: ${API_SERVER_URL}

      
    command:
      - start
      - --log-level=INFO
      - --import-realm
      - --proxy edge
      # - --db postgres
      # - --db-url-host postgres
      # - --db-username $PG_DB_USER
      # - --db-password $PG_DB_PASS
    volumes:
      - ${DOCKER_HOST_DIR}/keycloak/realm.json:/tmp/realm.json
    ports:
      - "8084:8080"

  postgres:
    image: postgis/postgis:15-master
    restart: always
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: ${PG_DB_USER}
      POSTGRES_PASSWORD: ${PG_DB_PASS}
    volumes:
      - pgdb:/var/lib/postgresql/data
      - ./postgres/sql_scripts:/docker-entrypoint-initdb.d
    logging:
      options:
        max-size: '10m'

  # pgadmin:
  #   container_name: pgadmin
  #   image: "dpage/pgadmin4:latest"
  #   environment:
  #     POSTGRES_USER: ${PG_DB_USER}
  #     POSTGRES_PASSWORD: ${PG_DB_PASS}
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
  #   ports:
  #     - "5050:80"

  conflictvisualizer-api:
    build:
      context: api
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    image: jpo-conflictvisualizer-api:latest
    restart: always
    environment:
      AUTH_SERVER_URL: ${AUTH_SERVER_URL}
      DB_HOST_IP: ${DB_HOST_IP}
      DB_HOST_PORT: ${DB_HOST_PORT}
      SPRING_KAFKA_BOOTSTRAPSERVERS: ${KAFKA_BROKER_IP}:${KAFKA_BROKER_PORT}
      CM_SERVER_URL: ${CM_SERVER_URL}
      load: "false"
      KAFKA_TYPE: "ON-PREM"
      ACM_CONFIG_FILE: adm.properties
      ACM_LOG_TO_CONSOLE: true
      ACM_LOG_TO_FILE: false
      ACM_LOG_LEVEL: DEBUG
      CM_MONGO_API_USERNAME: ${CM_MONGO_API_USERNAME}
      CM_MONGO_API_PASSWORD: ${CM_MONGO_API_PASSWORD}

      KEYCLOAK_CLIENT_API_ID: ${KEYCLOAK_CLIENT_API_ID}
      KEYCLOAK_CLIENT_API_SECRET: ${KEYCLOAK_CLIENT_API_SECRET}
      
      #KAFKA_BROKER_IP: ${KAFKA_BROKER_IP}
      #KAFKA_BROKER_PORT: ${KAFKA_BROKER_PORT}
    logging:
      options:
        max-size: "10m"
        max-file: "5"
    depends_on:
      keycloak:
        condition: service_started

volumes:
  pgdb:
    driver: local
